<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RANZ Compliance Wizard</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --ranz-charcoal: #3c4b5d;
            --ranz-blue: #00417a;
            --ranz-red: #be4039;
            --ranz-yellow: #fcb613;
            --ranz-silver: #939598;
            --light-bg: #f4f7f6;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--light-bg);
            color: var(--ranz-charcoal);
            margin: 0;
            padding: 0;
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: 15px;
        }

        /* --- LOGO BAR --- */
        .logo-bar {
            background-color: white;
            padding: 0.8rem 2rem;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
        }
        .logo-bar img { max-height: 50px; width: auto; display: block; }

        /* --- HEADER --- */
        header {
            background-color: var(--ranz-charcoal);
            color: white;
            position: relative;
            overflow: hidden;
            height: 140px;
            padding-top: 1.5rem;
            flex-shrink: 0;
        }

        .header-content {
            position: relative;
            z-index: 2;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        .diagonal-accent {
            position: absolute;
            top: 0;
            right: -100px;
            width: 60%;
            height: 100%;
            background-color: var(--ranz-blue);
            transform: skewX(-20deg);
            z-index: 1;
            opacity: 0.9;
        }

        h1 { font-weight: 800; text-transform: uppercase; margin: 0; font-size: 1.8rem; letter-spacing: 1px; }
        .subtitle { font-weight: 300; font-size: 0.95rem; margin-top: 0.2rem; opacity: 0.9; }

        /* --- MAIN CONTAINER --- */
        .container {
            max-width: 800px;
            margin: -30px auto 2rem; /* Overlap header */
            position: relative;
            z-index: 3;
            padding: 0 1rem;
            flex: 1;
            width: 100%;
            box-sizing: border-box;
        }

        /* --- CARD STYLES --- */
        .card {
            background: white;
            border-top: 5px solid var(--ranz-red);
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            padding: 2rem;
            margin-bottom: 2rem;
            display: none;
        }
        .card.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 {
            color: var(--ranz-blue);
            font-weight: 800;
            font-size: 1.4rem;
            margin: 0 0 1rem 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.8rem;
        }

        /* --- ALERTS & BOXES --- */
        .info-box, .warning-box, .case-study-box, .intro-box, .tech-alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .intro-box { background: white; border: 1px solid #eee; border-left: 5px solid var(--ranz-charcoal); }
        .info-box { background: #eef4f8; border-left: 5px solid var(--ranz-blue); }
        .warning-box { background: #fff3cd; border-left: 5px solid var(--ranz-yellow); color: #856404; }
        .case-study-box { background: #fff0f0; border-left: 5px solid var(--ranz-red); color: #721c24; }
        .tech-alert { background: #e3f2fd; border-left: 5px solid #2196f3; color: #0d47a1; }

        .box-title {
            font-weight: 800;
            display: flex;
            align-items: center;
            margin-bottom: 0.4rem;
            text-transform: uppercase;
            font-size: 0.8rem;
        }
        .case-study-box .box-title::before { content: "‚öñÔ∏è CASE LAW ALERT: "; margin-right: 5px; }
        .tech-alert .box-title::before { content: "üõ†Ô∏è TECHNICAL ALERT: "; margin-right: 5px; }

        .citation {
            font-size: 0.8rem;
            margin-top: 0.5rem;
            font-style: italic;
            opacity: 0.8;
            border-top: 1px solid rgba(0,0,0,0.1);
            padding-top: 5px;
        }

        /* --- FORM ELEMENTS --- */
        .option-group { display: grid; gap: 0.8rem; }
        
        .radio-label {
            display: block;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .radio-label:hover { border-color: var(--ranz-silver); background-color: #fafafa; }
        
        input[type="radio"], input[type="checkbox"] { display: none; }
        
        /* Checked state for Radio & Checkbox */
        input:checked + .radio-label {
            border-color: var(--ranz-blue);
            background-color: #f0f7fb;
            box-shadow: 0 0 0 1px var(--ranz-blue) inset;
        }
        
        /* Multiple Selection Indicator */
        input[type="checkbox"]:checked + .radio-label::after {
            content: "‚úî Selected";
            float: right;
            font-size: 0.8rem;
            font-weight: 800;
            color: var(--ranz-blue);
        }

        .option-title { font-weight: 700; display: block; margin-bottom: 3px; font-size: 1rem; }
        .option-desc { font-weight: 400; font-size: 0.85rem; color: #666; }

        /* --- BUTTONS --- */
        .actions { margin-top: 2rem; display: flex; gap: 1rem; }
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            font-size: 0.9rem;
            flex: 1;
            text-align: center;
        }
        .btn-next { background-color: var(--ranz-blue); color: white; }
        .btn-next:hover { background-color: #002a4d; }
        .btn-next:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-back { background-color: #e9ecef; color: #333; }
        .btn-back:hover { background-color: #dbe2e8; }

        /* --- RESULTS --- */
        .result-banner { text-align: center; padding: 1.5rem; color: white; border-radius: 6px; margin-bottom: 2rem; }
        .res-consent { background-color: var(--ranz-red); }
        .res-exempt { background-color: #28a745; }
        .res-check { background-color: var(--ranz-blue); }
        .res-commercial { background-color: var(--ranz-charcoal); }

        .checklist li { margin-bottom: 0.8rem; padding-bottom: 0.8rem; border-bottom: 1px solid #eee; }
        
        /* Legislation Breakdown */
        .leg-breakdown-area { margin-top: 3rem; border-top: 2px solid #eee; padding-top: 2rem; }
        .leg-block {
            border: 1px solid #eee;
            border-left: 4px solid var(--ranz-charcoal);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            background: #fafafa;
        }
        .leg-question { font-weight: 800; color: var(--ranz-blue); margin-bottom: 0.4rem; font-size: 0.85rem; text-transform: uppercase; border-bottom: 1px solid #e0e0e0; padding-bottom: 4px; }
        .leg-ref { font-weight: 700; color: var(--ranz-red); font-size: 0.9rem; margin-bottom: 0.4rem; display: block; }
        .leg-explain { font-size: 0.9rem; color: #444; line-height: 1.4; }

        /* Terms Box */
        .terms-container { background: #f9f9f9; border: 1px solid #ddd; padding: 1rem; font-size: 0.85rem; height: 120px; overflow-y: auto; margin-bottom: 1rem; border-radius: 4px; }
        .terms-check-wrapper { display: flex; align-items: center; margin-bottom: 1.5rem; padding: 0.8rem; background: #eef4f8; border-radius: 4px; }
        .terms-check-wrapper input { width: 20px; height: 20px; margin-right: 10px; display: block; }
        
        footer { text-align: center; padding: 2rem; font-size: 0.8rem; color: #888; }
    </style>
</head>
<body>

<div class="logo-bar">
    <img src="logo.png" alt="RANZ Logo">
</div>

<header>
    <div class="diagonal-accent"></div>
    <div class="header-content">
        <h1>Compliance Wizard</h1>
        <p class="subtitle">Consent, Licensing & LBP Obligations</p>
    </div>
</header>

<div class="container">

    <div class="card active" id="stepIntro">
        <h2>Welcome to the RANZ Compliance Wizard</h2>
        <div class="intro-box">
            <p>This tool helps Roofers, LBPs, and Homeowners determine their obligations under the <strong>Building Act 2004</strong> and the <strong>LBP Rules</strong>.</p>
            <p>Throughout this tool, you will see <strong>Case Law Alerts</strong> based on real, upheld complaints from the <strong>Building Practitioners Board (BPB)</strong>.</p>
        </div>
        <h3>Terms & Conditions of Use</h3>
        <div class="terms-container">
            <p><strong>1. No Data Storage or Verification:</strong> RANZ does not see, store, keep, endorse, or verify any of the information you enter into this tool. All data is processed locally on your device.</p>
            <p><strong>2. Membership Status:</strong> Usage of this tool does not imply that the user is a member of RANZ. Just because someone is using this application does not mean they are a RANZ member. To verify membership, you must check the official directory at ranz.co.nz.</p>
            <p><strong>3. Not Legal Advice:</strong> This tool is a guide based on the Building Act 2004 and BPB decisions. It is not a substitute for professional legal advice or specific guidance from your local Building Consent Authority (BCA).</p>
            <p><strong>4. Liability:</strong> RANZ accepts no liability for actions taken based on the outputs of this tool.</p>
        </div>
        <div class="terms-check-wrapper">
            <input type="checkbox" id="terms-check">
            <label for="terms-check"><strong>I have read and accept these Terms & Conditions.</strong></label>
        </div>
        <div class="actions">
            <button class="btn btn-next" id="btn-intro-start" disabled>Start Assessment</button>
        </div>
    </div>

    <div class="card" id="step0">
        <h2>Phase 1: What is your situation?</h2>
        <div class="option-group">
            <label><input type="radio" name="pathway" value="planning"><div class="radio-label"><span class="option-title">A. Planning & Pricing</span><span class="option-desc">"I am planning a job. Do I need a Consent? Do I need an LBP?"</span></div></label>
            <label><input type="radio" name="pathway" value="execution"><div class="radio-label"><span class="option-title">B. Doing the Work / Issues</span><span class="option-desc">"I am on site, making changes, supervising staff, or have a dispute."</span></div></label>
        </div>
        <div class="actions">
            <button class="btn btn-back" id="btn-back-0">Back</button>
            <button class="btn btn-next" id="btn-start">Next Step</button>
        </div>
    </div>

    <div class="card" id="stepP1">
        <h2>Step 1: The Job Scope</h2>
        <div class="case-study-box">
            <div class="box-title">Design Changes = No Exemption</div>
            In <em>Newton [2023]</em>, a roofer replaced a dormer but removed parapets. The Board ruled this was <strong>not</strong> "like-for-like". If you change the design, Schedule 1 does not apply.
            <div class="citation">Newton [2023] BPB CB26223</div>
        </div>
        <p><strong>What is the nature of the work?</strong></p>
        <div class="option-group">
            <label><input type="radio" name="scope" value="new"><div class="radio-label"><span class="option-title">A. New Build or Extension</span><span class="option-desc">New footprint or structural extension.</span></div></label>
            <label><input type="radio" name="scope" value="replace_same"><div class="radio-label"><span class="option-title">B. Like-for-Like Replacement</span><span class="option-desc">Same position, comparable materials.</span></div></label>
            <label><input type="radio" name="scope" value="replace_change"><div class="radio-label"><span class="option-title">C. Replacement with Design Changes</span><span class="option-desc">e.g. Removing parapets, changing pitch.</span></div></label>
        </div>
        <div class="actions">
            <button class="btn btn-back" id="btn-back-p1">Back</button>
            <button class="btn btn-next" id="btn-next-p1">Next Step</button>
        </div>
    </div>

    <div class="card" id="stepP1_Complex">
        <h2>Step 1b: Complex Scenarios & Risks</h2>
        <div class="tech-alert">
            <div class="box-title">High Risk Areas</div>
            Select <strong>ALL</strong> that apply. These scenarios often trigger Code issues (E1/E2/H1/Structural) even in "maintenance" jobs.
        </div>
        <p><strong>Does the job involve any of these specific scenarios?</strong></p>
        <div class="option-group">
            <label><input type="checkbox" name="complex" value="gutter" onclick="handleMulti(this)"><div class="radio-label"><span class="option-title">Internal Gutter -> External Conversion</span><span class="option-desc">Changing drainage system design (E1/E2).</span></div></label>
            <label><input type="checkbox" name="complex" value="skillion" onclick="handleMulti(this)"><div class="radio-label"><span class="option-title">Skillion Roof (No Cavity)</span><span class="option-desc">Risk of condensation if ventilation not added.</span></div></label>
            <label><input type="checkbox" name="complex" value="h1_upgrade" onclick="handleMulti(this)"><div class="radio-label"><span class="option-title">Insulation Upgrade (H1)</span><span class="option-desc">Installing thicker insulation (R6.6) or raising roof height.</span></div></label>
            <label><input type="checkbox" name="complex" value="solar" onclick="handleMulti(this)"><div class="radio-label"><span class="option-title">Solar Panels</span><span class="option-desc">Adding weight/penetrations. Structural check required.</span></div></label>
            <label><input type="checkbox" name="complex" value="asbestos" onclick="handleMulti(this)"><div class="radio-label"><span class="option-title">Pre-2000 / Asbestos Risk</span><span class="option-desc">Potential Health & Safety Stop Work.</span></div></label>
            <label><input type="checkbox" name="complex" value="none" onclick="handleMulti(this)"><div class="radio-label"><span class="option-title">None of the above</span><span class="option-desc">Standard re-roof or new build.</span></div></label>
        </div>
        <div class="actions">
            <button class="btn btn-back" id="btn-back-complex">Back</button>
            <button class="btn btn-next" id="btn-next-complex">Next Step</button>
        </div>
    </div>

    <div class="card" id="stepP1_Age">
        <h2>Step 1c: Age & Durability</h2>
        <div class="info-box">
            <div class="box-title">The 15-Year Rule</div>
            Exemption is EXCLUDED if the component failed before its 15-year durability requirement (Clause B2).
        </div>
        <p><strong>How old is the current roof?</strong></p>
        <div class="option-group">
            <label><input type="radio" name="age" value="old"><div class="radio-label"><span class="option-title">Over 15 Years Old</span><span class="option-desc">Normal end of life.</span></div></label>
            <label><input type="radio" name="age" value="young"><div class="radio-label"><span class="option-title">Under 15 Years Old</span><span class="option-desc">Premature failure.</span></div></label>
        </div>
        <div class="actions">
            <button class="btn btn-back" id="btn-back-age">Back</button>
            <button class="btn btn-next" id="btn-next-age">Next Step</button>
        </div>
    </div>

    <div class="card" id="stepP2">
        <h2>Step 2: Consent Status</h2>
        <div class="case-study-box">
            <div class="box-title">Duty to Check</div>
            In <em>Corbett-Pearson [2024]</em>, a roofer assumed a consent was in place but didn't check. The Board ruled the LBP is in the best position to stop unconsented work and failing to check is negligent.
            <div class="citation">Corbett-Pearson [2024] BPB 26512</div>
        </div>
        <p><strong>Has a Consent been issued?</strong></p>
        <div class="option-group">
            <label><input type="radio" name="consent_status" value="yes"><div class="radio-label"><span class="option-title">Yes, Consent Issued</span></div></label>
            <label><input type="radio" name="consent_status" value="emergency"><div class="radio-label"><span class="option-title">No - Emergency Work (s41c)</span><span class="option-desc">Immediate danger to people/property.</span></div></label>
            <label><input type="radio" name="consent_status" value="no_check"><div class="radio-label"><span class="option-title">Unsure / Not Confirmed</span></div></label>
        </div>
        <div class="actions">
            <button class="btn btn-back" id="btn-back-p2">Back</button>
            <button class="btn btn-next" id="btn-next-p2">Next Step</button>
        </div>
    </div>

    <div class="card" id="stepE0">
        <h2>Execution: Building Type</h2>
        <div class="info-box">
            <div class="box-title">Restricted Building Work</div>
            RBW rules specifically apply to <strong>residential</strong> buildings (houses and small-to-medium apartments).
        </div>
        <p><strong>Is this a Residential building?</strong></p>
        <div class="option-group">
            <label><input type="radio" name="b_type" value="residential"><div class="radio-label"><span class="option-title">Yes (House / Apartment)</span><span class="option-desc">Restricted Building Work rules apply.</span></div></label>
            <label><input type="radio" name="b_type" value="commercial"><div class="radio-label"><span class="option-title">No (Commercial / Industrial)</span><span class="option-desc">Warehouses, offices, etc.</span></div></label>
        </div>
        <div class="actions">
            <button class="btn btn-back" onclick="showStep('step0')">Back</button>
            <button class="btn btn-next" id="btn-next-e0">Next Step</button>
        </div>
    </div>

    <div class="card" id="stepE1">
        <h2>Execution: Making Changes</h2>
        <div class="case-study-box">
            <div class="box-title">"My way is better" Trap</div>
            In <em>Langdon [2025]</em>, a roofer was fined for using a "better" method without approval. In <em>Smith [2023]</em>, product substitution was a key issue.
            <div class="citation">Langdon [2025] BPB 26658</div>
        </div>
        <p><strong>Are you deviating from the Plans, altering an existing configuration, or substituting products?</strong></p>
        <div class="option-group">
            <label><input type="radio" name="variation" value="yes"><div class="radio-label"><span class="option-title">Yes</span><span class="option-desc">Changing flashings, details, pitch, layout, or substituting specified products.</span></div></label>
            <label><input type="radio" name="variation" value="no"><div class="radio-label"><span class="option-title">No</span><span class="option-desc">Following the consented plans and specifications exactly.</span></div></label>
        </div>
        <div class="actions">
            <button class="btn btn-back" id="btn-back-e1">Back</button>
            <button class="btn btn-next" id="btn-next-e1">Next Step</button>
        </div>
    </div>

    <div class="card" id="stepE1_Discovery">
        <h2>Execution: Substrate & Structure</h2>
        <div class="tech-alert">
            <div class="box-title">Substrate Responsibility</div>
            In <em>Woolhouse [2024]</em>, relying on the builder's incorrect set-out was no defence. Do not cover up non-compliant work.
        </div>
        <p><strong>Have you checked the substrate (purlins/ply/underlay) provided by previous trades?</strong></p>
        <div class="option-group">
            <label><input type="radio" name="discovery" value="structural"><div class="radio-label"><span class="option-title">I found issues (Rot/Errors)</span><span class="option-desc">Requires fixing/replacement before roofing.</span></div></label>
            <label><input type="radio" name="discovery" value="checked_ok"><div class="radio-label"><span class="option-title">Checked & Compliant</span><span class="option-desc">I have verified the substrate is ready.</span></div></label>
            <label><input type="radio" name="discovery" value="none"><div class="radio-label"><span class="option-title">I haven't checked</span><span class="option-desc">I am assuming the builder did it right.</span></div></label>
        </div>
        <div class="actions">
            <button class="btn btn-back" id="btn-back-discovery">Back</button>
            <button class="btn btn-next" id="btn-next-discovery">Next Step</button>
        </div>
    </div>

    <div class="card" id="stepE2_Licence">
        <h2>Execution: Licence Class</h2>
        <div class="case-study-box">
            <div class="box-title">Scope of Licence</div>
            In <em>Casha [2025]</em>, a roofer was fined for doing work outside his specific licence class (Membrane vs Metal).
        </div>
        <p><strong>Do you hold the specific Licence Class for the material you are installing?</strong></p>
        <div class="option-group">
            <label><input type="radio" name="licence" value="yes"><div class="radio-label"><span class="option-title">Yes</span><span class="option-desc">e.g. I have a Membrane licence and I am installing Membrane.</span></div></label>
            <label><input type="radio" name="licence" value="no"><div class="radio-label"><span class="option-title">No / Different Class</span><span class="option-desc">e.g. I am a Metal roofer installing Membrane.</span></div></label>
        </div>
        <div class="actions">
            <button class="btn btn-back" id="btn-back-licence">Back</button>
            <button class="btn btn-next" id="btn-next-licence">Next Step</button>
        </div>
    </div>

    <div class="card" id="stepE2">
        <h2>Execution: Supervision</h2>
        <div class="case-study-box">
            <div class="box-title">Remote Supervision</div>
            In <em>Horrack [2024]</em>, the Board ruled "Remote supervision does not mean NO supervision".
            <div class="citation">Horrack [2024] BPB 26456</div>
        </div>
        <p><strong>How are you supervising this job?</strong></p>
        <div class="option-group">
            <label><input type="radio" name="supervision" value="self"><div class="radio-label"><span class="option-title">I am doing it myself</span></div></label>
            <label><input type="radio" name="supervision" value="check"><div class="radio-label"><span class="option-title">Supervising others (Physical Checks)</span></div></label>
            <label><input type="radio" name="supervision" value="remote"><div class="radio-label"><span class="option-title">Remote / No Inspection</span></div></label>
        </div>
        <div class="actions">
            <button class="btn btn-back" id="btn-back-e2">Back</button>
            <button class="btn btn-next" id="btn-next-e2">Next Step</button>
        </div>
    </div>

    <div class="card" id="stepE3">
        <h2>Execution: Completion</h2>
        <div class="warning-box">
            <div class="box-title">Withholding Paperwork</div>
            In <em>Moyes [2025]</em>, an LBP was fined for withholding a Record of Work due to unpaid invoices.
            <div class="citation">Moyes [2025] BPB 26670</div>
        </div>
        <p><strong>What is the job status?</strong></p>
        <div class="option-group">
            <label><input type="radio" name="completion" value="in_progress"><div class="radio-label"><span class="option-title">Work in Progress (No Issues)</span></div></label>
            <label><input type="radio" name="completion" value="finished"><div class="radio-label"><span class="option-title">Job Completed Normally</span></div></label>
            <label><input type="radio" name="completion" value="dispute"><div class="radio-label"><span class="option-title">Dispute / Payment Issue</span></div></label>
            <label><input type="radio" name="completion" value="terminated"><div class="radio-label"><span class="option-title">Contract Terminated / Walked Off</span></div></label>
        </div>
        <div class="actions">
            <button class="btn btn-back" id="btn-back-e3">Back</button>
            <button class="btn btn-next" id="btn-next-e3">Get Determination</button>
        </div>
    </div>

    <div class="card" id="stepResults">
        <div id="result-banner" class="result-banner"></div>
        <h3>Critical Compliance Checklist:</h3>
        <ul class="checklist" id="final-checklist"></ul>
        <div id="warnings-section" style="margin-top: 2rem;"></div>
        
        <div class="leg-breakdown-area">
            <h3>Legislation & Rules Breakdown</h3>
            <p style="margin-bottom:1rem; font-size:0.9rem; color:#666;">Detailed reference for the logic applied to your assessment.</p>
            <div id="legislation-breakdown"></div>
        </div>

        <div class="actions" style="grid-template-columns: 1fr 1fr;">
            <button class="btn btn-back" id="btn-back-results">Back</button>
            <button class="btn btn-next" onclick="location.reload()">Start New Assessment</button>
        </div>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        var state = { pathway:null, scope:null, complex:[], age:null, consent_status:null, b_type:null, variation:null, discovery:null, licence:null, supervision:null, completion:null };

        // Terms
        var termsCheck = document.getElementById('terms-check');
        var startBtn = document.getElementById('btn-intro-start');
        termsCheck.addEventListener('change', function() { startBtn.disabled = !this.checked; });

        // MULTI SELECT HELPER
        window.handleMulti = function(el) {
            var all = document.querySelectorAll('input[name="complex"]');
            if(el.value === 'none') {
                if(el.checked) {
                    all.forEach(c => { if(c.value !== 'none') c.checked = false; });
                }
            } else {
                if(el.checked) {
                    document.querySelector('input[value="none"]').checked = false;
                }
            }
        };

        // EXPLANATIONS (NO LINKS)
        const explanations = {
            scope: {
                question: "Scope of Work",
                new: { ref: "Building Act 2004, Section 40", text: "<strong>Section 40:</strong> 'A person must not carry out any building work except in accordance with a building consent.' New builds do not fit the definition of maintenance/replacement under Schedule 1." },
                replace_same: { ref: "Building Act 2004, Schedule 1, Part 1, Clause 1", text: "<strong>Exemption 1:</strong> Covers 'General repair, maintenance, and replacement'. Crucially, it only applies if you use 'comparable materials' in the 'same position'." },
                replace_change: { ref: "Building Act 2004, Schedule 1 & Newton [2023]", text: "In <em>Newton [2023]</em>, the BPB ruled that removing parapets constituted a change in design/position. This voided the Schedule 1 exemption." }
            },
            complex: {
                question: "Complex / Risks",
                gutter: { ref: "Building Code E1/E2", text: "Converting gutters alters drainage design. Consent required." },
                skillion: { ref: "Building Code H1/E3", text: "Skillion roofs need ventilation to prevent condensation. Design advice recommended." },
                solar: { ref: "Building Code B1", text: "Solar panels add weight. Structural check required." },
                asbestos: { ref: "Health & Safety at Work Act", text: "Asbestos must be identified. Stop work order risk." },
                h1_upgrade: { ref: "Building Code H1 / E2", text: "Upgrading insulation often increases roof depth, affecting flashing cover and building envelope height." },
                none: { ref: "N/A", text: "Standard scope." }
            },
            age: {
                question: "15-Year Rule",
                young: { ref: "Schedule 1, Clause 1(a)(ii)", text: "No exemption if failed <15 years." },
                old: { ref: "Schedule 1", text: "Likely maintenance exemption." }
            },
            consent_status: {
                question: "Consent Check",
                no_check: { ref: "Corbett-Pearson", text: "Failing to check consent is negligence." },
                emergency: { ref: "Building Act s41(c)", text: "Emergency work allowed but requires Certificate of Acceptance (s42) immediately after." }
            },
            b_type: {
                question: "Building Type",
                residential: { ref: "RBW Order 2011", text: "RBW applies to residential housing." },
                commercial: { ref: "Building Act", text: "Commercial is not RBW." }
            },
            variation: {
                question: "Deviations/Substitution",
                yes: { ref: "Langdon [2025] & Smith [2023]", text: "Substitution or variation requires Form 45A approval." }
            },
            discovery: {
                question: "Substrate/Structure",
                structural: { ref: "Building Act s112", text: "Replacing structure is RBW. Must meet current code." },
                none: { ref: "Woolhouse [2024]", text: "Failing to check substrate is negligence." }
            },
            licence: {
                question: "Licence Class",
                no: { ref: "Casha [2025]", text: "Working outside licence class is a disciplinary offence." }
            },
            supervision: {
                question: "Supervision",
                remote: { ref: "Horrack [2024]", text: "Must physically inspect." }
            },
            completion: {
                question: "Completion",
                dispute: { ref: "Moyes [2025]", text: "Withholding RoW is illegal." },
                terminated: { ref: "McKinstry [2023]", text: "Completion = End of contract." }
            }
        };

        function showStep(id) {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // HANDLERS
        document.getElementById('btn-intro-start').addEventListener('click', () => showStep('step0'));
        document.getElementById('btn-back-0').addEventListener('click', () => showStep('stepIntro'));
        document.getElementById('btn-start').addEventListener('click', () => {
            state.pathway = document.querySelector('input[name="pathway"]:checked')?.value;
            if(!state.pathway) return alert("Select pathway");
            showStep(state.pathway === 'planning' ? 'stepP1' : 'stepE0');
        });

        // Planning
        document.getElementById('btn-back-p1').addEventListener('click', () => showStep('step0'));
        document.getElementById('btn-next-p1').addEventListener('click', () => {
            state.scope = document.querySelector('input[name="scope"]:checked')?.value;
            if(!state.scope) return alert("Select scope");
            showStep('stepP1_Complex');
        });
        document.getElementById('btn-back-complex').addEventListener('click', () => showStep('stepP1'));
        document.getElementById('btn-next-complex').addEventListener('click', () => {
            // MULTI SELECT CAPTURE
            var checked = document.querySelectorAll('input[name="complex"]:checked');
            if(checked.length === 0) return alert("Select at least one option (or None)");
            state.complex = Array.from(checked).map(c => c.value);
            
            showStep(state.scope === 'replace_same' ? 'stepP1_Age' : 'stepP2');
        });
        document.getElementById('btn-back-age').addEventListener('click', () => showStep('stepP1_Complex'));
        document.getElementById('btn-next-age').addEventListener('click', () => {
            state.age = document.querySelector('input[name="age"]:checked')?.value;
            if(!state.age) return alert("Select age");
            showStep('stepP2');
        });
        document.getElementById('btn-back-p2').addEventListener('click', () => showStep(state.scope === 'replace_same' ? 'stepP1_Age' : 'stepP1_Complex'));
        document.getElementById('btn-next-p2').addEventListener('click', () => {
            state.consent_status = document.querySelector('input[name="consent_status"]:checked')?.value;
            if(!state.consent_status) return alert("Confirm status");
            calcPlanning();
        });

        // Execution
        document.getElementById('btn-next-e0').addEventListener('click', () => {
            state.b_type = document.querySelector('input[name="b_type"]:checked')?.value;
            if(!state.b_type) return alert("Select type");
            showStep('stepE1');
        });
        document.getElementById('btn-back-e1').addEventListener('click', () => showStep('stepE0'));
        document.getElementById('btn-next-e1').addEventListener('click', () => {
            state.variation = document.querySelector('input[name="variation"]:checked')?.value;
            if(!state.variation) return alert("Answer variation");
            showStep('stepE1_Discovery');
        });
        document.getElementById('btn-back-discovery').addEventListener('click', () => showStep('stepE1'));
        document.getElementById('btn-next-discovery').addEventListener('click', () => {
            state.discovery = document.querySelector('input[name="discovery"]:checked')?.value;
            if(!state.discovery) return alert("Answer discovery");
            showStep('stepE2_Licence');
        });
        document.getElementById('btn-back-licence').addEventListener('click', () => showStep('stepE1_Discovery'));
        document.getElementById('btn-next-licence').addEventListener('click', () => {
            state.licence = document.querySelector('input[name="licence"]:checked')?.value;
            if(!state.licence) return alert("Answer licence check");
            showStep('stepE2');
        });

        document.getElementById('btn-back-e2').addEventListener('click', () => showStep('stepE2_Licence'));
        document.getElementById('btn-next-e2').addEventListener('click', () => {
            state.supervision = document.querySelector('input[name="supervision"]:checked')?.value;
            if(!state.supervision) return alert("Answer supervision");
            showStep('stepE3');
        });
        document.getElementById('btn-back-e3').addEventListener('click', () => showStep('stepE2'));
        document.getElementById('btn-next-e3').addEventListener('click', () => {
            state.completion = document.querySelector('input[name="completion"]:checked')?.value;
            if(!state.completion) return alert("Answer completion");
            calcExecution();
        });

        // RESULTS BACK BUTTON HANDLER
        document.getElementById('btn-back-results').addEventListener('click', () => {
            if (state.pathway === 'planning') {
                showStep('stepP2');
            } else {
                showStep('stepE3');
            }
        });

        function renderLeg(keys) {
            let html = "";
            keys.forEach(k => {
                let v = state[k];
                // Handle array for 'complex'
                if(Array.isArray(v)) {
                    v.forEach(item => {
                         if(explanations[k] && explanations[k][item]) {
                             html += `<div class="leg-block"><div class="leg-question">${explanations[k].question} (${item})</div><div class="leg-ref">${explanations[k][item].ref}</div><div class="leg-explain">${explanations[k][item].text}</div></div>`;
                         }
                    });
                } else {
                    if(v && explanations[k] && explanations[k][v]) {
                        html += `<div class="leg-block"><div class="leg-question">${explanations[k].question}</div><div class="leg-ref">${explanations[k][v].ref}</div><div class="leg-explain">${explanations[k][v].text}</div></div>`;
                    }
                }
            });
            document.getElementById('legislation-breakdown').innerHTML = html;
        }

        function calcPlanning() {
            let reasons=[], warnings=[], isReq=false;
            
            // Check Complex Array
            let complexHasRisk = state.complex.some(x => ['gutter'].includes(x));
            if(complexHasRisk) isReq=true;
            
            if(state.scope!=='replace_same') isReq=true;
            if(state.age==='young') isReq=true;

            let banner = document.getElementById('result-banner');
            if(isReq) {
                banner.className="result-banner res-consent";
                banner.innerHTML="<h1>CONSENT & LBP REQUIRED</h1>";
            } else {
                banner.className="result-banner res-exempt";
                banner.innerHTML="<h1>LIKELY EXEMPT</h1>";
            }
            
            if(isReq) reasons.push("<strong>LBP Required:</strong> Restricted Building Work.");
            else reasons.push("<strong>No LBP Mandate:</strong> (But recommended).");
            
            // --- EDUCATIONAL ALERTS ---
            if(state.complex.includes('solar')) {
                warnings.push('<div class="tech-alert"><span class="box-title">Solar & Structure (Education)</span><strong>Why it matters:</strong> Solar panels alter the structural load path. Standard roof trusses are designed for "distributed loads" (like snow or iron), not the "point loads" of solar rails. <br><br><strong>Action:</strong> You must verify the structure can take the weight (Clause B1) and that penetrations are flashed (Clause E2). If in doubt, get an engineer\'s letter.</div>');
            }
            
            if(state.complex.includes('asbestos')) {
                warnings.push('<div class="tech-alert"><span class="box-title">Asbestos & The Law (Education)</span><strong>The Rule:</strong> Under the Health & Safety at Work Act, any building constructed pre-2000 is <em>presumed</em> to contain asbestos until proven otherwise.<br><br><strong>Risk:</strong> You generally cannot disturb materials (like soffits, decramastic tiles, or fibro) without a negative test. Fines for site contamination are severe.</div>');
            }
            
            // SKILLION UPDATE
            if(state.complex.includes('skillion')) {
                warnings.push('<div class="tech-alert"><span class="box-title">Skillion Ventilation (Recommended)</span><strong>The Issue:</strong> Skillion roofs lack a large cavity to buffer moisture. Horizontal purlins often block the 25mm air gap, acting as a "dam" for stagnant, moist air.<br><br><strong>The Fix (Passive System):</strong> Ensure <strong>continuous airflow</strong> using:<br>1. <strong>Inlet Vents</strong> (Fascia) to let air in.<br>2. <strong>Vented Battens</strong> (over purlins) to ensure air can travel <em>through</em> the roof structure.<br>3. <strong>Ridge Vents</strong> to let warm air escape.<br><em>(See systems like VentNZ for compliant solutions).</em></div>');
            }

            if(state.complex.includes('gutter')) {
                warnings.push('<div class="tech-alert"><span class="box-title">Internal Gutters (Education)</span><strong>Why Consent is needed:</strong> Converting an internal gutter to an external one changes the building\'s water management design (Clause E1). This is not "maintenance"; it is a modification of the building envelope.</div>');
            }
            
            if(state.complex.includes('h1_upgrade')) {
                warnings.push('<div class="warning-box"><span class="box-title">H1 Height Check</span><strong>Warning:</strong> Thicker insulation often raises the roof profile. Check that your flashings still provide compliant cover (E2). If the roof plane changes height, this is a structural change (Minor Variation or Consent required).</div>');
            }

            if(state.consent_status==='no_check' && isReq) warnings.push('<div class="case-study-box"><span class="box-title">Danger</span>Failing to check for consent is negligence (<em>Corbett-Pearson</em>). Verify now.</div>');
            if(state.consent_status==='emergency') reasons.push("<strong>Action:</strong> Apply for Certificate of Acceptance (s42) immediately.");

            document.getElementById('final-checklist').innerHTML = reasons.map(r=>"<li>"+r+"</li>").join('');
            document.getElementById('warnings-section').innerHTML = warnings.join('');
            renderLeg(['scope','complex','age','consent_status']);
            showStep('stepResults');
        }

        function calcExecution() {
            let reasons=[], warnings=[];
            let banner = document.getElementById('result-banner');
            
            if(state.b_type === 'commercial') {
                banner.className="result-banner res-commercial";
                banner.innerHTML="<h1>COMMERCIAL: LBP NOT MANDATED</h1>";
                reasons.push("Commercial work is generally not RBW.");
            } else {
                // Residential Logic
                if(state.discovery==='structural') {
                    banner.className="result-banner res-consent";
                    banner.innerHTML="<h1>LBP REQUIRED</h1><p>Structural Work Discovered (RBW)</p>";
                } else {
                    banner.className="result-banner res-consent";
                    banner.innerHTML="<h1>LBP REQUIRED</h1><p>Residential Roofing is Restricted Building Work</p>";
                }
            }

            // CHECKLIST
            if (state.b_type === 'residential') {
                reasons.push("<strong>Residential Rule:</strong> This work is Restricted Building Work (RBW). It must be supervised by an LBP.");
            }

            if (state.variation === 'yes') {
                warnings.push('<div class="case-study-box"><div class="box-title">STOP: Variation / Substitution</div>Unapproved changes = Fines (<em>Langdon</em>). Apply for Minor Variation (Form 45A).</div>');
            }
            if (state.discovery === 'structural') {
                reasons.push("<strong>Structural Finding:</strong> Replacing substrate/purlins is RBW. New work MUST meet current code (s112).");
            }
            
            // SUBSTRATE LIABILITY - EXPANDED EDUCATION
            if (state.discovery === 'none') {
                warnings.push('<div class="case-study-box"><span class="box-title">Substrate Liability (Education)</span><strong>Why this matters:</strong> As the specialist trade, you are the final check. In <em>Woolhouse [2024]</em>, the Board ruled that if you cover up a builder\'s mistake (like bad purlin spacing or missing tapes), you <strong>adopt that defect</strong> as your own.<br><br><strong>Advice:</strong> Always inspect the substrate before starting.</div>');
            }
            
            if (state.licence === 'no') {
                warnings.push('<div class="case-study-box"><div class="box-title">Licence Breach</div>You are working outside your licence class (<em>Casha</em>). You cannot supervise this work.</div>');
            }

            if (state.supervision === 'remote') {
                warnings.push('<div class="case-study-box"><div class="box-title">Supervision Risk</div>Remote supervision requires physical inspection (<em>Horrack</em>).</div>');
                reasons.push("<strong>Action:</strong> Schedule a physical site inspection immediately.");
            }
            
            if(state.completion === 'in_progress') {
                reasons.push("<strong>Status:</strong> Work in progress. Maintain compliant supervision.");
                if(state.b_type === 'residential') reasons.push("<strong>Reminder:</strong> Issue Record of Work upon completion.");
            } else if (state.completion === 'dispute') {
                warnings.push('<div class="case-study-box"><div class="box-title">Issue RoW Now</div>Do not withhold RoW for payment (<em>Moyes</em>).</div>');
                if(state.b_type === 'residential') reasons.push("<strong>Action:</strong> Issue Record of Work immediately.");
            } else if (state.completion === 'terminated') {
                 if(state.b_type === 'residential') reasons.push("<strong>Action:</strong> Issue RoW for work done so far (<em>McKinstry</em>).");
            }

            if (state.b_type === 'residential') {
                reasons.push("<strong>General:</strong> Send RoW to Owner AND Council.");
            }

            document.getElementById('final-checklist').innerHTML = reasons.map(r => "<li>"+r+"</li>").join('');
            document.getElementById('warnings-section').innerHTML = warnings.join('');
            renderLeg(['b_type', 'variation', 'discovery', 'licence', 'supervision', 'completion']);
            showStep('stepResults');
        }
    });
</script>

</body>
</html>
