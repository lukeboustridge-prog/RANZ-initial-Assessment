<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RANZ Compliance Master Tool</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --ranz-charcoal: #3c4b5d;
            --ranz-blue: #00417a;
            --ranz-red: #be4039;
            --ranz-yellow: #fcb613;
            --ranz-silver: #939598;
            --light-bg: #f4f7f6;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--light-bg);
            color: var(--ranz-charcoal);
            margin: 0;
            padding: 0;
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: 15px;
        }

        /* --- LOGO BAR --- */
        .logo-bar {
            background-color: white;
            padding: 0.8rem 2rem;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
        }
        .logo-bar img { max-height: 50px; width: auto; display: block; }

        /* --- HEADER --- */
        header {
            background-color: var(--ranz-charcoal);
            color: white;
            position: relative;
            overflow: hidden;
            height: 140px;
            padding-top: 1.5rem;
            flex-shrink: 0;
        }

        .header-content {
            position: relative;
            z-index: 2;
            max-width: 800px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        .diagonal-accent {
            position: absolute;
            top: 0;
            right: -100px;
            width: 60%;
            height: 100%;
            background-color: var(--ranz-blue);
            transform: skewX(-20deg);
            z-index: 1;
            opacity: 0.9;
        }

        h1 { font-weight: 800; text-transform: uppercase; margin: 0; font-size: 1.8rem; letter-spacing: 1px; }
        .subtitle { font-weight: 300; font-size: 0.95rem; margin-top: 0.2rem; opacity: 0.9; }

        /* --- MAIN CONTAINER --- */
        .container {
            max-width: 800px;
            margin: -30px auto 2rem; /* Overlap header */
            position: relative;
            z-index: 3;
            padding: 0 1rem;
            flex: 1;
            width: 100%;
            box-sizing: border-box;
        }

        /* --- CARD STYLES --- */
        .card {
            background: white;
            border-top: 5px solid var(--ranz-red);
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            padding: 2rem;
            margin-bottom: 2rem;
            display: none;
        }
        .card.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h2 {
            color: var(--ranz-blue);
            font-weight: 800;
            font-size: 1.4rem;
            margin: 0 0 1rem 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.8rem;
        }

        /* --- ALERTS & BOXES --- */
        .info-box, .warning-box, .case-study-box, .intro-box, .tech-alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .intro-box { background: white; border: 1px solid #eee; border-left: 5px solid var(--ranz-charcoal); }
        .info-box { background: #eef4f8; border-left: 5px solid var(--ranz-blue); }
        .warning-box { background: #fff3cd; border-left: 5px solid var(--ranz-yellow); color: #856404; }
        .case-study-box { background: #fff0f0; border-left: 5px solid var(--ranz-red); color: #721c24; }
        .tech-alert { background: #e3f2fd; border-left: 5px solid #2196f3; color: #0d47a1; }

        .box-title {
            font-weight: 800;
            display: flex;
            align-items: center;
            margin-bottom: 0.4rem;
            text-transform: uppercase;
            font-size: 0.8rem;
        }
        .case-study-box .box-title::before { content: "‚öñÔ∏è CASE LAW ALERT: "; margin-right: 5px; }
        .tech-alert .box-title::before { content: "üõ†Ô∏è TECHNICAL ALERT: "; margin-right: 5px; }

        .citation {
            font-size: 0.8rem;
            margin-top: 0.5rem;
            font-style: italic;
            opacity: 0.8;
            border-top: 1px solid rgba(0,0,0,0.1);
            padding-top: 5px;
        }

        /* --- FORM ELEMENTS --- */
        .option-group { display: grid; gap: 0.8rem; }
        
        .radio-label {
            display: block;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .radio-label:hover { border-color: var(--ranz-silver); background-color: #fafafa; }
        
        input[type="radio"] { display: none; }
        input[type="radio"]:checked + .radio-label {
            border-color: var(--ranz-blue);
            background-color: #f0f7fb;
            box-shadow: 0 0 0 1px var(--ranz-blue) inset;
        }

        .option-title { font-weight: 700; display: block; margin-bottom: 3px; font-size: 1rem; }
        .option-desc { font-weight: 400; font-size: 0.85rem; color: #666; }

        /* --- BUTTONS --- */
        .actions { margin-top: 2rem; display: flex; gap: 1rem; }
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            font-size: 0.9rem;
            flex: 1;
            text-align: center;
        }
        .btn-next { background-color: var(--ranz-blue); color: white; }
        .btn-next:hover { background-color: #002a4d; }
        .btn-next:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-back { background-color: #e9ecef; color: #333; }
        .btn-back:hover { background-color: #dbe2e8; }

        /* --- RESULTS --- */
        .result-banner { text-align: center; padding: 1.5rem; color: white; border-radius: 6px; margin-bottom: 2rem; }
        .res-consent { background-color: var(--ranz-red); }
        .res-exempt { background-color: #28a745; }
        .res-check { background-color: var(--ranz-blue); }
        .res-commercial { background-color: var(--ranz-charcoal); }

        .checklist li { margin-bottom: 0.8rem; padding-bottom: 0.8rem; border-bottom: 1px solid #eee; }
        
        /* Legislation Breakdown */
        .leg-breakdown-area { margin-top: 3rem; border-top: 2px solid #eee; padding-top: 2rem; }
        .leg-block {
            border: 1px solid #eee;
            border-left: 4px solid var(--ranz-charcoal);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            background: #fafafa;
        }
        .leg-question { font-weight: 800; color: var(--ranz-blue); margin-bottom: 0.4rem; font-size: 0.85rem; text-transform: uppercase; border-bottom: 1px solid #e0e0e0; padding-bottom: 4px; }
        .leg-ref { font-weight: 700; color: var(--ranz-red); font-size: 0.9rem; margin-bottom: 0.4rem; display: block; }
        .leg-explain { font-size: 0.9rem; color: #444; line-height: 1.4; }

        /* Terms Box */
        .terms-container { background: #f9f9f9; border: 1px solid #ddd; padding: 1rem; font-size: 0.85rem; height: 120px; overflow-y: auto; margin-bottom: 1rem; border-radius: 4px; }
        .terms-check-wrapper { display: flex; align-items: center; margin-bottom: 1.5rem; padding: 0.8rem; background: #eef4f8; border-radius: 4px; }
        .terms-check-wrapper input { width: 20px; height: 20px; margin-right: 10px; display: block; }
        
        footer { text-align: center; padding: 2rem; font-size: 0.8rem; color: #888; }
    </style>
</head>
<body>

<div class="logo-bar">
    <img src="logo.png" alt="RANZ Logo">
</div>

<header>
    <div class="diagonal-accent"></div>
    <div class="header-content">
        <h1>Compliance Master</h1>
        <p class="subtitle">Consent, Licensing & LBP Obligations</p>
    </div>
</header>

<div class="container">

    <div class="card active" id="stepIntro">
        <h2>Welcome to the RANZ Compliance Wizard</h2>
        <div class="intro-box">
            <p>This tool helps Roofers, LBPs, and Homeowners determine their obligations under the <strong>Building Act 2004</strong> and the <strong>LBP Rules</strong>.</p>
            <p>Throughout this tool, you will see <strong>Case Law Alerts</strong> based on real, upheld complaints from the <strong>Building Practitioners Board (BPB)</strong>.</p>
        </div>
        <h3>Terms & Conditions of Use</h3>
        <div class="terms-container">
            <p><strong>1. No Data Storage or Verification:</strong> RANZ does not see, store, keep, endorse, or verify any of the information you enter into this tool. All data is processed locally on your device.</p>
            <p><strong>2. Membership Status:</strong> Usage of this tool does not imply that the user is a member of RANZ. Just because someone is using this application does not mean they are a RANZ member. To verify membership, you must check the official directory at ranz.co.nz.</p>
            <p><strong>3. Not Legal Advice:</strong> This tool is a guide based on the Building Act 2004 and BPB decisions. It is not a substitute for professional legal advice or specific guidance from your local Building Consent Authority (BCA).</p>
            <p><strong>4. Liability:</strong> RANZ accepts no liability for actions taken based on the outputs of this tool.</p>
        </div>
        <div class="terms-check-wrapper">
            <input type="checkbox" id="terms-check">
            <label for="terms-check"><strong>I have read and accept these Terms & Conditions.</strong></label>
        </div>
        <div class="actions">
            <button class="btn btn-next" id="btn-intro-start" disabled>Start Assessment</button>
        </div>
    </div>

    <div class="card" id="step0">
        <h2>Phase 1: What is your situation?</h2>
        <div class="option-group">
            <label><input type="radio" name="pathway" value="planning"><div class="radio-label"><span class="option-title">A. Planning & Pricing</span><span class="option-desc">"I am planning a job. Do I need a Consent? Do I need an LBP?"</span></div></label>
            <label><input type="radio" name="pathway" value="execution"><div class="radio-label"><span class="option-title">B. Doing the Work / Issues</span><span class="option-desc">"I am on site, making changes, supervising staff, or have a dispute."</span></div></label>
        </div>
        <div class="actions">
            <button class="btn btn-back" id="btn-back-0">Back</button>
            <button class="btn btn-next" id="btn-start">Next Step</button>
        </div>
    </div>

    <div class="card" id="stepP1">
        <h2>Step 1: The Job Scope</h2>
        <div class="case-study-box">
            <div class="box-title">Design Changes = No Exemption</div>
            In <em>Newton [2023]</em>, a roofer replaced a dormer but removed parapets. The Board ruled this was <strong>not</strong> "like-for-like". If you change the design, Schedule 1 does not apply.
            <div class="citation">Newton [2023] BPB CB26223</div>
        </div>
        <p><strong>What is the nature of the work?</strong></p>
        <div class="option-group">
            <label><input type="radio" name="scope" value="new"><div class="radio-label"><span class="option-title">A. New Build or Extension</span><span class="option-desc">New footprint or structural extension.</span></div></label>
            <label><input type="radio" name="scope" value="replace_same"><div class="radio-label"><span class="option-title">B. Like-for-Like Replacement</span><span class="option-desc">Same position, comparable materials.</span></div></label>
            <label><input type="radio" name="scope" value="replace_change"><div class="radio-label"><span class="option-title">C. Replacement with Design Changes</span><span class="option-desc">e.g. Removing parapets, changing pitch.</span></div></label>
        </div>
        <div class="actions">
            <button class="btn btn-back" id="btn-back-p1">Back</button>
            <button class="btn btn-next" id="btn-next-p1">Next Step</button>
        </div>
    </div>

    <div class="card" id="stepP1_Complex">
        <h2>Step 1b: Complex Scenarios</h2>
        <div class="tech-alert">
            <div class="box-title">Grey Areas</div>
            Some jobs look like "replacement" but trigger Code issues (E1/E2/H1).
        </div>
        <p><strong>Does the job involve any of these specific scenarios?</strong></p>
        <div class="option-group">
            <label><input type="radio" name="complex" value="gutter"><div class="radio-label"><span class="option-title">Internal Gutter -> External Conversion</span><span class="option-desc">Changing drainage system design.</span></div></label>
            <label><input type="radio" name="complex" value="skillion"><div class="radio-label"><span class="option-title">Skillion Roof (No Cavity)</span><span class="option-desc">Re-roofing a skillion, potentially adding vents.</span></div></label>
            <label><input type="radio" name="complex" value="none"><div class="radio-label"><span class="option-title">None of the above</span><span class="option-desc">Standard re-roof or new build.</span></div></label>
        </div>
        <div class="actions">
            <button class="btn btn-back" id="btn-back-complex">Back</button>
            <button class="btn btn-next" id="btn-next-complex">Next Step</button>
        </div>
    </div>

    <div class="card" id="stepP1_Age">
        <h2>Step 1c: Age & Durability</h2>
        <div class="info-box">
            <div class="box-title">The 15-Year Rule</div>
            Exemption is EXCLUDED if the component failed before its 15-year durability requirement (Clause B2).
        </div>
        <p><strong>How old is the current roof?</strong></p>
        <div class="option-group">
            <label><input type="radio" name="age" value="old"><div class="radio-label"><span class="option-title">Over 15 Years Old</span><span class="option-desc">Normal end of life.</span></div></label>
            <label><input type="radio" name="age" value="young"><div class="radio-label"><span class="option-title">Under 15 Years Old</span><span class="option-desc">Premature failure.</span></div></label>
        </div>
        <div class="actions">
            <button class="btn btn-back" id="btn-back-age">Back</button>
            <button class="btn btn-next" id="btn-next-age">Next Step</button>
        </div>
    </div>

    <div class="card" id="stepP2">
        <h2>Step 2: Consent Status</h2>
        <div class="case-study-box">
            <div class="box-title">Duty to Check</div>
            In <em>Corbett-Pearson [2024]</em>, failing to check for a consent before starting was deemed negligence.
            <div class="citation">Corbett-Pearson [2024] BPB 26512</div>
        </div>
        <p><strong>Has a Consent been issued?</strong></p>
        <div class="option-group">
            <label><input type="radio" name="consent_status" value="yes"><div class="radio-label"><span class="option-title">Yes, Consent Issued</span></div></label>
            <label><input type="radio" name="consent_status" value="no_check"><div class="radio-label"><span class="option-title">Unsure / Not Confirmed</span></div></label>
        </div>
        <div class="actions">
            <button class="btn btn-back" id="btn-back-p2">Back</button>
            <button class="btn btn-next" id="btn-next-p2">Next Step</button>
        </div>
    </div>

    <div class="card" id="stepE0">
        <h2>Execution: Building Type</h2>
        <div class="info-box">
            <div class="box-title">Restricted Building Work</div>
            RBW rules specifically apply to <strong>residential</strong> buildings (houses and small-to-medium apartments).
        </div>
        <p><strong>Is this a Residential building?</strong></p>
        <div class="option-group">
            <label><input type="radio" name="b_type" value="residential"><div class="radio-label"><span class="option-title">Yes (House / Apartment)</span><span class="option-desc">Restricted Building Work rules apply.</span></div></label>
            <label><input type="radio" name="b_type" value="commercial"><div class="radio-label"><span class="option-title">No (Commercial / Industrial)</span><span class="option-desc">Warehouses, offices, etc.</span></div></label>
        </div>
        <div class="actions">
            <button class="btn btn-back" onclick="showStep('step0')">Back</button>
            <button class="btn btn-next" id="btn-next-e0">Next Step</button>
        </div>
    </div>

    <div class="card" id="stepE1">
        <h2>Execution: Making Changes</h2>
        <div class="case-study-box">
            <div class="box-title">"My way is better" Trap</div>
            In <em>Langdon [2025]</em>, a roofer was fined for using a "better" method without approval.
            <div class="citation">Langdon [2025] BPB 26658</div>
        </div>
        <p><strong>Are you deviating from the Plans or altering an existing configuration?</strong></p>
        <div class="option-group">
            <label><input type="radio" name="variation" value="yes"><div class="radio-label"><span class="option-title">Yes</span><span class="option-desc">Changing flashings, profiles, details, pitch, or drainage layout (e.g. internal to external gutters).</span></div></label>
            <label><input type="radio" name="variation" value="no"><div class="radio-label"><span class="option-title">No</span><span class="option-desc">Following the consented plans or original design exactly.</span></div></label>
        </div>
        <div class="actions">
            <button class="btn btn-back" id="btn-back-e1">Back</button>
            <button class="btn btn-next" id="btn-next-e1">Next Step</button>
        </div>
    </div>

    <div class="card" id="stepE1_Discovery">
        <h2>Execution: Unforeseen Discovery</h2>
        <div class="tech-alert">
            <div class="box-title">Structural Upgrades</div>
            If you uncover non-compliant structure, you cannot simply cover it up.
        </div>
        <p><strong>Have you found non-compliant structure?</strong></p>
        <div class="option-group">
            <label><input type="radio" name="discovery" value="structural"><div class="radio-label"><span class="option-title">Yes (Rotten timber, wrong fixings, old ply)</span></div></label>
            <label><input type="radio" name="discovery" value="none"><div class="radio-label"><span class="option-title">No / Minor issues only</span></div></label>
        </div>
        <div class="actions">
            <button class="btn btn-back" id="btn-back-discovery">Back</button>
            <button class="btn btn-next" id="btn-next-discovery">Next Step</button>
        </div>
    </div>

    <div class="card" id="stepE2">
        <h2>Execution: Supervision</h2>
        <div class="case-study-box">
            <div class="box-title">Remote Supervision</div>
            In <em>Horrack [2024]</em>, the Board ruled "Remote supervision does not mean NO supervision".
            <div class="citation">Horrack [2024] BPB 26456</div>
        </div>
        <p><strong>How are you supervising this job?</strong></p>
        <div class="option-group">
            <label><input type="radio" name="supervision" value="self"><div class="radio-label"><span class="option-title">I am doing it myself</span></div></label>
            <label><input type="radio" name="supervision" value="check"><div class="radio-label"><span class="option-title">Supervising others (Physical Checks)</span></div></label>
            <label><input type="radio" name="supervision" value="remote"><div class="radio-label"><span class="option-title">Remote / No Inspection</span></div></label>
        </div>
        <div class="actions">
            <button class="btn btn-back" id="btn-back-e2">Back</button>
            <button class="btn btn-next" id="btn-next-e2">Next Step</button>
        </div>
    </div>

    <div class="card" id="stepE3">
        <h2>Execution: Completion</h2>
        <div class="warning-box">
            <div class="box-title">Withholding Paperwork</div>
            In <em>Moyes [2025]</em>, an LBP was fined for withholding a Record of Work due to unpaid invoices.
            <div class="citation">Moyes [2025] BPB 26670</div>
        </div>
        <p><strong>What is the job status?</strong></p>
        <div class="option-group">
            <label><input type="radio" name="completion" value="in_progress"><div class="radio-label"><span class="option-title">Work in Progress (No Issues)</span></div></label>
            <label><input type="radio" name="completion" value="finished"><div class="radio-label"><span class="option-title">Job Completed Normally</span></div></label>
            <label><input type="radio" name="completion" value="dispute"><div class="radio-label"><span class="option-title">Dispute / Payment Issue</span></div></label>
            <label><input type="radio" name="completion" value="terminated"><div class="radio-label"><span class="option-title">Contract Terminated / Walked Off</span></div></label>
        </div>
        <div class="actions">
            <button class="btn btn-back" id="btn-back-e3">Back</button>
            <button class="btn btn-next" id="btn-next-e3">Get Determination</button>
        </div>
    </div>

    <div class="card" id="stepResults">
        <div id="result-banner" class="result-banner"></div>
        <h3>Critical Compliance Checklist:</h3>
        <ul class="checklist" id="final-checklist"></ul>
        <div id="warnings-section" style="margin-top: 2rem;"></div>
        
        <div class="leg-breakdown-area">
            <h3>Legislation & Rules Breakdown</h3>
            <p style="margin-bottom:1rem; font-size:0.9rem; color:#666;">Detailed reference for the logic applied to your assessment.</p>
            <div id="legislation-breakdown"></div>
        </div>

        <div class="actions" style="grid-template-columns: 1fr 1fr;">
            <button class="btn btn-back" id="btn-back-results">Back</button>
            <button class="btn btn-next" onclick="location.reload()">Start New Assessment</button>
        </div>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        var state = { pathway:null, scope:null, complex:null, age:null, consent_status:null, b_type:null, variation:null, discovery:null, supervision:null, completion:null };

        // Terms
        var termsCheck = document.getElementById('terms-check');
        var startBtn = document.getElementById('btn-intro-start');
        termsCheck.addEventListener('change', function() { startBtn.disabled = !this.checked; });

        // EXPLANATIONS (NO LINKS)
        const explanations = {
            scope: {
                question: "Scope of Work",
                new: { ref: "Building Act 2004, Section 40", text: "<strong>Section 40:</strong> 'A person must not carry out any building work except in accordance with a building consent.' New builds do not fit the definition of maintenance/replacement under Schedule 1." },
                replace_same: { ref: "Building Act 2004, Schedule 1, Part 1, Clause 1", text: "<strong>Exemption 1:</strong> Covers 'General repair, maintenance, and replacement'. Crucially, it only applies if you use 'comparable materials' in the 'same position'." },
                replace_change: { ref: "Building Act 2004, Schedule 1 & Newton [2023]", text: "In <em>Newton [2023]</em>, the BPB ruled that removing parapets constituted a change in design/position. This voided the Schedule 1 exemption because it was no longer 'comparable replacement'." }
            },
            complex: {
                question: "Complex / Grey Area Scenarios",
                gutter: { ref: "Building Code Clause E1 & E2", text: "Converting Internal gutters to External is <strong>not</strong> like-for-like. It alters the building's drainage system design and weathertightness envelope." },
                skillion: { ref: "Building Code Clause H1 & E3", text: "Re-roofing a skillion without adding ventilation can create condensation issues (a breach of E3). However, adding vents is a design change." },
                none: { ref: "N/A", text: "No specific complex scenario selected." }
            },
            age: {
                question: "15-Year Durability Rule",
                young: { ref: "Building Act 2004, Schedule 1, Clause 1(a)(ii)", text: "<strong>The Exemption Exclusion:</strong> Schedule 1 explicitly states you CANNOT use the exemption if the component has 'failed to satisfy the provisions of the building code for durability' (i.e., failed before 15 years)." },
                old: { ref: "Building Act 2004, Schedule 1", text: "The roof has exceeded its 15-year B2 Durability requirement. Replacement is considered valid maintenance." }
            },
            consent_status: {
                question: "Building Consent Check",
                yes: { ref: "Building Act 2004, Section 40", text: "Building work must proceed exactly in accordance with the issued consent." },
                no_check: { ref: "Corbett-Pearson [2024] BPB 26512", text: "<strong>Negligence Finding:</strong> The Board ruled that the LBP is in the best position to ensure unconsented work does not occur. Failing to verify the consent status before starting is a disciplinary offence." }
            },
            b_type: {
                question: "Building Type (Residential vs Commercial)",
                residential: { ref: "Building (Definition of Restricted Building Work) Order 2011", text: "RBW applies to residential housing. Work involving the primary structure or weathertightness of a house must be done by an LBP." },
                commercial: { ref: "Building Act 2004", text: "Commercial buildings generally do not have 'Restricted Building Work' requirements for structure/weathertightness, meaning an LBP is not legally mandated for the physical work." }
            },
            variation: {
                question: "Deviations from Plans",
                yes: { ref: "Building Act 2004, Section 45A & Langdon [2025]", text: "<strong>Section 45A:</strong> Minor variations must be approved by the BCA. In <em>Langdon [2025]</em>, an LBP was fined for using a 'better' method that wasn't on the plans. You cannot deviate without prior approval." },
                no: { ref: "Building Act 2004", text: "Proceeding in accordance with stamped plans." }
            },
            discovery: {
                question: "Unforeseen Structural Issues",
                structural: { ref: "Building Act 2004, Section 112", text: "<strong>Section 112:</strong> Alterations must ensure the building complies with the Building Code 'as near as is reasonably practicable'. Replacing rotten purlins is Restricted Building Work." },
                none: { ref: "N/A", text: "No structural issues found." }
            },
            supervision: {
                question: "Supervision Requirements",
                self: { ref: "LBP Rules", text: "Direct accountability." },
                check: { ref: "Building Act 2004, Section 7", text: "Meets definition of 'direction and oversight'." },
                remote: { ref: "Horrack [2024] BPB 26456", text: "<strong>Supervision Definition:</strong> The Board ruled that 'Remote supervision does not mean NO supervision'. A supervisor must have knowledge of the work and carry out actual inspections. Relying solely on trust is insufficient." }
            },
            completion: {
                question: "Completion & Record of Work",
                finished: { ref: "Building Act 2004, Section 88", text: "<strong>Section 88:</strong> Each LBP who carries out RBW must provide a Record of Work to the Owner and the Territorial Authority on completion." },
                dispute: { ref: "Moyes [2025] BPB 26670", text: "<strong>Case Law:</strong> 'A Record of Work is a statutory requirement, not a negotiable term of a contract.' Withholding it due to payment disputes is a disciplinary offence." },
                terminated: { ref: "McKinstry [2023] BPB 26342", text: "<strong>Definition of Completion:</strong> The Board clarified that 'Completion' means the date your engagement ended. Even if the roof isn't finished, you must provide a RoW for the work you did complete." },
                in_progress: { ref: "Best Practice", text: "Work ongoing. Maintain compliant supervision levels until completion." }
            }
        };

        function showStep(id) {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // HANDLERS
        document.getElementById('btn-intro-start').addEventListener('click', () => showStep('step0'));
        document.getElementById('btn-back-0').addEventListener('click', () => showStep('stepIntro'));
        document.getElementById('btn-start').addEventListener('click', () => {
            state.pathway = document.querySelector('input[name="pathway"]:checked')?.value;
            if(!state.pathway) return alert("Select pathway");
            showStep(state.pathway === 'planning' ? 'stepP1' : 'stepE0');
        });

        // Planning
        document.getElementById('btn-back-p1').addEventListener('click', () => showStep('step0'));
        document.getElementById('btn-next-p1').addEventListener('click', () => {
            state.scope = document.querySelector('input[name="scope"]:checked')?.value;
            if(!state.scope) return alert("Select scope");
            showStep('stepP1_Complex');
        });
        document.getElementById('btn-back-complex').addEventListener('click', () => showStep('stepP1'));
        document.getElementById('btn-next-complex').addEventListener('click', () => {
            state.complex = document.querySelector('input[name="complex"]:checked')?.value;
            if(!state.complex) return alert("Select option");
            showStep(state.scope === 'replace_same' ? 'stepP1_Age' : 'stepP2');
        });
        document.getElementById('btn-back-age').addEventListener('click', () => showStep('stepP1_Complex'));
        document.getElementById('btn-next-age').addEventListener('click', () => {
            state.age = document.querySelector('input[name="age"]:checked')?.value;
            if(!state.age) return alert("Select age");
            showStep('stepP2');
        });
        document.getElementById('btn-back-p2').addEventListener('click', () => showStep(state.scope === 'replace_same' ? 'stepP1_Age' : 'stepP1_Complex'));
        document.getElementById('btn-next-p2').addEventListener('click', () => {
            state.consent_status = document.querySelector('input[name="consent_status"]:checked')?.value;
            if(!state.consent_status) return alert("Confirm status");
            calcPlanning();
        });

        // Execution
        document.getElementById('btn-next-e0').addEventListener('click', () => {
            state.b_type = document.querySelector('input[name="b_type"]:checked')?.value;
            if(!state.b_type) return alert("Select type");
            showStep('stepE1');
        });
        document.getElementById('btn-back-e1').addEventListener('click', () => showStep('stepE0'));
        document.getElementById('btn-next-e1').addEventListener('click', () => {
            state.variation = document.querySelector('input[name="variation"]:checked')?.value;
            if(!state.variation) return alert("Answer variation");
            showStep('stepE1_Discovery');
        });
        document.getElementById('btn-back-discovery').addEventListener('click', () => showStep('stepE1'));
        document.getElementById('btn-next-discovery').addEventListener('click', () => {
            state.discovery = document.querySelector('input[name="discovery"]:checked')?.value;
            if(!state.discovery) return alert("Answer discovery");
            showStep('stepE2');
        });
        document.getElementById('btn-back-e2').addEventListener('click', () => showStep('stepE1_Discovery'));
        document.getElementById('btn-next-e2').addEventListener('click', () => {
            state.supervision = document.querySelector('input[name="supervision"]:checked')?.value;
            if(!state.supervision) return alert("Answer supervision");
            showStep('stepE3');
        });
        document.getElementById('btn-back-e3').addEventListener('click', () => showStep('stepE2'));
        document.getElementById('btn-next-e3').addEventListener('click', () => {
            state.completion = document.querySelector('input[name="completion"]:checked')?.value;
            if(!state.completion) return alert("Answer completion");
            calcExecution();
        });

        // RESULTS BACK BUTTON HANDLER
        document.getElementById('btn-back-results').addEventListener('click', () => {
            if (state.pathway === 'planning') {
                showStep('stepP2');
            } else {
                showStep('stepE3');
            }
        });

        function renderLeg(keys) {
            let html = "";
            keys.forEach(k => {
                let v = state[k];
                if(v && explanations[k] && explanations[k][v]) {
                    html += `<div class="leg-block"><div class="leg-question">${explanations[k].question}</div><div class="leg-ref">${explanations[k][v].ref}</div><div class="leg-explain">${explanations[k][v].text}</div></div>`;
                }
            });
            document.getElementById('legislation-breakdown').innerHTML = html;
        }

        function calcPlanning() {
            let reasons=[], warnings=[], isReq=false;
            if(state.complex!=='none') isReq=true;
            if(state.scope!=='replace_same') isReq=true;
            if(state.age==='young') isReq=true;

            let banner = document.getElementById('result-banner');
            if(isReq) {
                banner.className="result-banner res-consent";
                banner.innerHTML="<h1>CONSENT & LBP REQUIRED</h1>";
            } else {
                banner.className="result-banner res-exempt";
                banner.innerHTML="<h1>LIKELY EXEMPT</h1>";
            }
            
            if(isReq) reasons.push("<strong>LBP Required:</strong> Restricted Building Work.");
            else reasons.push("<strong>No LBP Mandate:</strong> (But recommended).");

            if(state.consent_status==='no_check' && isReq) warnings.push('<div class="case-study-box"><span class="box-title">Danger</span>Failing to check for consent is negligence (<em>Corbett-Pearson</em>). Verify now.</div>');

            document.getElementById('final-checklist').innerHTML = reasons.map(r=>"<li>"+r+"</li>").join('');
            document.getElementById('warnings-section').innerHTML = warnings.join('');
            renderLeg(['scope','complex','age','consent_status']);
            showStep('stepResults');
        }

        function calcExecution() {
            let reasons=[], warnings=[];
            let banner = document.getElementById('result-banner');
            
            if(state.b_type === 'commercial') {
                banner.className="result-banner res-commercial";
                banner.innerHTML="<h1>COMMERCIAL: LBP NOT MANDATED</h1>";
                reasons.push("Commercial work is generally not RBW.");
            } else {
                // Residential Logic
                if(state.discovery==='structural') {
                    banner.className="result-banner res-consent";
                    banner.innerHTML="<h1>LBP REQUIRED</h1><p>Structural Work Discovered (RBW)</p>";
                } else {
                    banner.className="result-banner res-consent";
                    banner.innerHTML="<h1>LBP REQUIRED</h1><p>Residential Roofing is Restricted Building Work</p>";
                }
                reasons.push("<strong>Residential Rule:</strong> Work on the primary structure or weathertightness of a house is Restricted Building Work (RBW). It must be supervised by an LBP.");
            }

            if(state.variation==='yes') warnings.push('<div class="case-study-box"><span class="box-title">Variation Risk</span>Unapproved changes = Fines (<em>Langdon</em>). Apply for Minor Variation (Form 45A).</div>');
            
            if(state.discovery==='structural') {
                reasons.push("<strong>Structural Finding:</strong> Replacing substrate/purlins is RBW. New work MUST meet current code (s112).");
            }
            
            if(state.supervision==='remote') {
                warnings.push('<div class="case-study-box"><span class="box-title">Supervision Risk</span>Remote supervision requires physical inspection (<em>Horrack</em>).</div>');
                reasons.push("<strong>Action:</strong> Schedule a physical site inspection immediately.");
            }
            
            if(state.completion==='dispute') {
                warnings.push('<div class="case-study-box"><span class="box-title">Record of Work</span>Do not withhold RoW for payment (<em>Moyes</em>).</div>');
                if(state.b_type === 'residential') reasons.push("<strong>Action:</strong> Issue Record of Work immediately.");
            } else if(state.completion==='terminated') {
                 if(state.b_type === 'residential') reasons.push("<strong>Action:</strong> Issue RoW for work done so far (<em>McKinstry</em>).");
            } else if(state.completion === 'in_progress') {
                reasons.push("<strong>Status:</strong> Work in progress. Maintain compliant supervision.");
                if(state.b_type === 'residential') reasons.push("<strong>Reminder:</strong> Issue Record of Work upon completion.");
            } else {
                if(state.b_type === 'residential') reasons.push("<strong>General:</strong> Send RoW to Owner AND Council.");
            }

            document.getElementById('final-checklist').innerHTML = reasons.map(r=>"<li>"+r+"</li>").join('');
            document.getElementById('warnings-section').innerHTML = warnings.join('');
            renderLeg(['b_type','variation','discovery','supervision','completion']);
            showStep('stepResults');
        }
    });
</script>

</body>
</html>
